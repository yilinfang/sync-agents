#!/usr/bin/env bash
set -euo pipefail

# sync-agents.sh
# Synchronize AGENTS.md, CLAUDE.md locally and globally.
# Globally, also synchronize with GEMINI.md.
# Synchronize .agents/skills/, .claude/skills/, .gemini/antigravity/skills/
# for both the current directory (local) and the home directory (global).

DRY_RUN=false
RUN_LOCAL=false
RUN_GLOBAL=false
RUN_ALL=false
LOCAL_FLAG_USED=false
HARD_COPY=false
NO_ARGS=false
SYNC_CONFIG=true
SYNC_SKILLS=true

[[ $# -eq 0 ]] && NO_ARGS=true

usage() {
	cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Synchronize AGENTS.md and CLAUDE.md (and GEMINI.md globally),
and their respective skills directories for the current directory and/or home.

Options:
  --local        Deprecated: local is already the default scope
  --global       Sync only the home directory (~/)
  --all          Sync both current directory and home directory
  --skills-only  Sync only skills directories (skip config files)
  --config-only  Sync only config files (skip skills directories)
  --dry-run      Show what would be done without making any changes
  --hard         Copy files/directories instead of creating symlinks
  -h, --help     Show this help message

Default scope is local. Use --global for home only, --all for both,
or --local --global together for both.
If neither --skills-only nor --config-only is specified, both config and skills are synced.
EOF
	exit 0
}

while [[ $# -gt 0 ]]; do
	case "$1" in
	--local)
		RUN_LOCAL=true
		LOCAL_FLAG_USED=true
		shift
		;;
	--global)
		RUN_GLOBAL=true
		shift
		;;
	--all)
		RUN_ALL=true
		shift
		;;
	--skills-only)
		SYNC_CONFIG=false
		shift
		;;
	--config-only)
		SYNC_SKILLS=false
		shift
		;;
	--dry-run)
		DRY_RUN=true
		shift
		;;
	--hard)
		HARD_COPY=true
		shift
		;;
	-h | --help) usage ;;
	*)
		echo "Error: Unknown option '$1'" >&2
		echo "Run '$(basename "$0") --help' for usage." >&2
		exit 1
		;;
	esac
done

# Default to dry-run when invoked with no arguments.
if $NO_ARGS; then
	DRY_RUN=true
fi

# Scope selection:
# - default (no scope flags) and --local only: local
# - --global only: global
# - --all: both
# - --local --global: both
if $RUN_ALL; then
	RUN_LOCAL=true
	RUN_GLOBAL=true
elif $RUN_LOCAL && $RUN_GLOBAL; then
	RUN_LOCAL=true
	RUN_GLOBAL=true
elif $RUN_GLOBAL; then
	RUN_LOCAL=false
	RUN_GLOBAL=true
else
	RUN_LOCAL=true
	RUN_GLOBAL=false
fi

# --skills-only and --config-only are mutually exclusive in effect (each turns off the other half).
# If both were given, last one wins; if neither, both SYNC_CONFIG and SYNC_SKILLS stay true.

confirm() {
	local msg="$1"
	printf "  %s [y/N] " "$msg" >&2
	read -r answer
	[[ "$answer" =~ ^[Yy]$ ]]
}

do_link_or_copy() {
	local src="$1"
	local dst="$2"

	mkdir -p "$(dirname "$dst")"
	if $HARD_COPY; then
		if [[ -d "$src" ]]; then
			cp -r "$src" "$dst"
		else
			cp "$src" "$dst"
		fi
	else
		ln -s "$src" "$dst"
	fi
}

label_action() {
	if $HARD_COPY; then
		echo "copy"
	else
		echo "link"
	fi
}

sync_group() {
	local items=("$@")
	local existing=()
	local missing=()
	local action
	action="$(label_action)"

	for item in "${items[@]}"; do
		if [[ -e "$item" || -L "$item" ]]; then
			existing+=("$item")
		else
			missing+=("$item")
		fi
	done

	if [[ ${#existing[@]} -eq 0 ]]; then
		echo "  [skip]  None of the items exist (${items[*]}). Nothing to do."
		return
	fi

	local source="${existing[0]}"
	local has_conflict=false

	# Check all existing items for conflicts (against source and each other).
	if [[ ${#existing[@]} -gt 1 ]]; then
		for item in "${existing[@]:1}"; do
			if ! $HARD_COPY; then
				local src_is_link=false
				local item_is_link=false
				[[ -L "$source" ]] && src_is_link=true
				[[ -L "$item" ]] && item_is_link=true

				if $item_is_link && [[ "$(readlink "$item")" == "$source" ]]; then
					echo "  [ok]    $item -> $source (already linked)"
				elif $src_is_link && [[ "$(readlink "$source")" == "$item" ]]; then
					echo "  [ok]    $source -> $item (already linked)"
				elif $item_is_link && $src_is_link && [[ "$(readlink "$source")" == "$(readlink "$item")" ]]; then
					echo "  [ok]    $source and $item share the same target (already linked)"
				else
					echo "  [skip]  Both $source and $item exist independently. Resolve manually."
					has_conflict=true
				fi
			else
				echo "  [skip]  Both $source and $item exist independently. Resolve manually."
				has_conflict=true
			fi
		done
	fi

	# Don't create missing items when conflicts exist among existing ones.
	if $has_conflict; then
		if [[ ${#missing[@]} -gt 0 ]]; then
			echo "  [skip]  Skipping missing items (${missing[*]}) due to unresolved conflicts above."
		fi
		return
	fi

	for item in "${missing[@]}"; do
		if $DRY_RUN; then
			echo "  [dry]   Would $action $item <- $source"
		else
			if confirm "$action $item <- $source?"; then
				do_link_or_copy "$source" "$item"
				echo "  [$action]  $item <- $source"
			else
				echo "  [skip]  Skipped by user."
			fi
		fi
	done
}

if $DRY_RUN && $NO_ARGS; then
	echo "(no arguments — running in dry-run mode, use --local/--global/--all to apply changes)"
elif $DRY_RUN; then
	echo "(dry-run mode — no changes will be made)"
fi
if $LOCAL_FLAG_USED; then
	echo "(deprecated) --local is deprecated; local is already the default scope." >&2
fi
if $HARD_COPY; then
	echo "(hard-copy mode — copying instead of symlinking)"
fi
echo ""

# --- Local (current directory) ---
if $RUN_LOCAL; then
	echo "=== Local: $(pwd) ==="

	if $SYNC_CONFIG; then
		echo "--- AGENTS.md / CLAUDE.md ---"
		sync_group "AGENTS.md" "CLAUDE.md"
	fi
	if $SYNC_SKILLS; then
		echo "--- .agents/skills / .claude/skills / .gemini/antigravity/skills ---"
		sync_group ".agents/skills" ".claude/skills" ".gemini/antigravity/skills"
	fi

	echo ""
fi

# --- Global (home directory) ---
if $RUN_GLOBAL; then
	echo "=== Global: $HOME ==="

	if $SYNC_CONFIG; then
		echo "--- ~/.codex/AGENTS.md / ~/.claude/CLAUDE.md / ~/.gemini/GEMINI.md ---"
		sync_group "$HOME/.codex/AGENTS.md" "$HOME/.claude/CLAUDE.md" "$HOME/.gemini/GEMINI.md"
	fi
	if $SYNC_SKILLS; then
		echo "--- ~/.agents/skills / ~/.claude/skills / ~/.gemini/antigravity/skills ---"
		sync_group "$HOME/.agents/skills" "$HOME/.claude/skills" "$HOME/.gemini/antigravity/skills"
	fi

	echo ""
fi

echo "Done."
